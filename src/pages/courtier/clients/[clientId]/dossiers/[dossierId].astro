---
import BaseLayout from '../../../../../layouts/BaseLayout.astro';
import Navbar from '../../../../../components/Navbar.astro';
import Footer from '../../../../../components/Footer.astro';
import StatusBadge from '../../../../../components/courtier/StatusBadge.svelte';
import ScoreChart from '../../../../../components/courtier/ScoreChart.svelte';
import { isPro } from '../../../../../lib/subscription';
import { createServerSupabaseClient } from '../../../../../lib/supabase';
import { getClient, getDossier, getDiagnostics } from '../../../../../lib/courtier';

const { userId } = Astro.locals.auth();
if (!userId) return Astro.redirect('/connexion');

const user = await Astro.locals.currentUser();
if (!isPro(user)) return Astro.redirect('/premium?upgrade=pro');

const { clientId, dossierId } = Astro.params;
const supabase = createServerSupabaseClient();

let client, dossier, diagnostics;
try {
  [client, dossier, diagnostics] = await Promise.all([
    getClient(clientId!, supabase),
    getDossier(dossierId!, supabase),
    getDiagnostics(dossierId!, supabase),
  ]);
} catch {
  return Astro.redirect(`/courtier/clients/${clientId}`);
}

const dernierDiag = diagnostics[0] ?? null;
const scorePoints = [...diagnostics]
  .map(d => ({ created_at: d.created_at, score_global: d.score_global }))
  .reverse();

const prioriteLabel = { bloquant: 'Bloquant', important: 'Important', conseil: 'Conseil' };
const prioriteColor = {
  bloquant: 'bg-red-50 text-red-700 dark:bg-red-900/20 dark:text-red-400',
  important: 'bg-amber-50 text-amber-700 dark:bg-amber-900/20 dark:text-amber-400',
  conseil: 'bg-blue-50 text-blue-700 dark:bg-blue-900/20 dark:text-blue-400',
};
---

<BaseLayout title={`${dossier.titre} | DossierPrêt`} description="Détail dossier." noindex={true}>
  <div class="min-h-screen flex flex-col">
    <Navbar currentPath="/courtier" />

    <main class="flex-1 py-12 bg-gray-50 dark:bg-slate-900 transition-colors duration-200">
      <div class="container-main max-w-3xl">

        <a href={`/courtier/clients/${clientId}`} class="text-xs text-gray-400 dark:text-slate-500 hover:text-gray-600 dark:hover:text-slate-300 transition-colors mb-4 block">
          ← {client.nom}
        </a>

        <!-- Header dossier -->
        <div class="card mb-6">
          <div class="flex items-start justify-between gap-4">
            <div>
              <h1 class="text-xl font-bold text-gray-900 dark:text-white">{dossier.titre}</h1>
              <p class="text-xs text-gray-400 dark:text-slate-500 mt-1">
                Créé le {new Date(dossier.created_at).toLocaleDateString('fr-FR')}
              </p>
            </div>
            <StatusBadge client:load statut={dossier.statut} dossierId={dossier.id} editable={true} />
          </div>
          <div class="mt-4">
            <a
              href={`/courtier/clients/${clientId}/dossiers/${dossierId}/diagnostic`}
              class="inline-flex items-center gap-2 px-4 py-2.5 bg-gray-900 dark:bg-slate-100 text-white dark:text-slate-900 text-sm font-semibold rounded-lg hover:bg-gray-800 dark:hover:bg-white transition-colors"
            >
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
              Lancer un diagnostic
            </a>
          </div>
        </div>

        <!-- Score du dernier diagnostic -->
        {dernierDiag && (
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
            {[
              { label: 'Score global', value: `${dernierDiag.score_global}/100` },
              { label: 'Taux endettement', value: `${dernierDiag.taux_endettement.toFixed(1)}%` },
              { label: 'Mensualité', value: `${Math.round(dernierDiag.mensualite).toLocaleString('fr-FR')} €` },
              { label: 'HCSF', value: dernierDiag.hcsf_ok ? 'Conforme' : 'Non conforme' },
            ].map(s => (
              <div class="card text-center">
                <p class="text-lg font-bold text-gray-900 dark:text-white">{s.value}</p>
                <p class="text-xs text-gray-400 dark:text-slate-500 mt-0.5">{s.label}</p>
              </div>
            ))}
          </div>
        )}

        <!-- Courbe d'évolution -->
        {scorePoints.length > 1 && (
          <div class="card mb-6">
            <h2 class="text-sm font-semibold text-gray-900 dark:text-white mb-4">Évolution du score</h2>
            <ScoreChart client:load diagnostics={scorePoints} />
          </div>
        )}

        <!-- Conseils du dernier diagnostic -->
        {dernierDiag && dernierDiag.actions.length > 0 && (
          <div class="card mb-6">
            <h2 class="text-sm font-semibold text-gray-900 dark:text-white mb-4">
              Plan d'action — dernier diagnostic
            </h2>
            <div class="flex flex-col gap-3">
              {dernierDiag.actions.map((a: { priorite: 'bloquant' | 'important' | 'conseil'; titre: string; detail: string }) => (
                <div class={`rounded-xl p-4 ${prioriteColor[a.priorite]}`}>
                  <div class="flex items-center gap-2 mb-1">
                    <span class="text-xs font-semibold uppercase tracking-wider opacity-70">{prioriteLabel[a.priorite]}</span>
                  </div>
                  <p class="text-sm font-medium">{a.titre}</p>
                  <p class="text-xs mt-1 opacity-80 leading-relaxed">{a.detail}</p>
                </div>
              ))}
            </div>
          </div>
        )}

        <!-- Historique diagnostics -->
        {diagnostics.length > 0 && (
          <div class="card">
            <h2 class="text-sm font-semibold text-gray-900 dark:text-white mb-4">
              Historique des diagnostics ({diagnostics.length})
            </h2>
            <div class="divide-y divide-gray-100 dark:divide-slate-700/50">
              {diagnostics.map((d, i) => (
                <div class="py-3 flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-gray-900 dark:text-white">
                      Score : {d.score_global}/100
                      {i === 0 && <span class="ml-2 text-xs text-gray-400 dark:text-slate-500">Dernier</span>}
                    </p>
                    <p class="text-xs text-gray-400 dark:text-slate-500 mt-0.5">
                      {new Date(d.created_at).toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' })}
                    </p>
                  </div>
                  <span class={`text-xs font-medium px-2.5 py-1 rounded-full ${d.hcsf_ok ? 'bg-green-50 text-green-700 dark:bg-green-900/20 dark:text-green-400' : 'bg-red-50 text-red-700 dark:bg-red-900/20 dark:text-red-400'}`}>
                    {d.hcsf_ok ? 'HCSF ✓' : 'HCSF ✗'}
                  </span>
                </div>
              ))}
            </div>
          </div>
        )}

      </div>
    </main>
    <Footer />
  </div>
</BaseLayout>
